---
title: 主函数体
date: 2024-10-14
updated: 2024-10-14
permalink: articles/Zhong classmate/项目1-提瓦特幸存者/
categories: Zhong classmate
tags: [项目总结]
---

# 主函数

## 通用设计思想

````c++
int main()
{
    //窗口初始化
    ....
    //资源加载与初始化等操作
    ....
    //计时器定义
    DWORD start_time ;//控制帧率的开始时刻
	DWORD end_time  ;//控制帧率的结束时刻
	DWORD delta_time=0 ;//用于控制帧率的时间差
	DWORD anim_delta_time = 0;//记录绘制一帧所需时间的时间差
    //游戏主循环体
    while (running)
    {
        //重置计时器相关属性
        start_time=当前时刻
        //玩家消息队列处理
        ....
        // 处理数据
        	//敌人状态变化逻辑处理
            ....
            //碰撞检测
                //敌人与玩家碰撞
                ....//玩家若死亡，running=false
                //玩家相关碰撞
                	//玩家与玩家碰撞
                	....//玩家若死亡，running=false
                	//玩家与场景碰撞
                	....//玩家若死亡，running=false
                //敌人相关碰撞 
                	//敌人与场景碰撞
               		....
            //移除生命值归零的敌人
            ....
            //判断游戏是否继续进行
            ....//若running=false，游戏结束
        // 渲染图片逻辑
        	//清屏
        	.....
            //双缓冲处理过程
            .....
        	//绘制图片
            .....
        //计时器相关属性处理
        end_time=当前时刻
        delta_time=end_time-start_time;
        // 帧率控制
        .....
        //绘制一帧所需时间计时器更新
        anim_delta_time=当前时刻-start_time
    }
}
````





## 本项目实现代码

```c++
int main()
{
    //窗口初始化
	initgraph(1280, 720);
	//资源加载
	atlas_player_left = new Atlas(_T("img/player_left_%d.png"), 6);
	atlas_player_right = new Atlas(_T("img/player_right_%d.png"), 6);
	atlas_enemy_left = new Atlas(_T("img/enemy_left_%d.png"), 6);
	atlas_enemy_right = new Atlas(_T("img/enemy_right_%d.png"), 6);
	mciSendString(_T("open mus/hit.wav alias hit"), NULL, 0, NULL);
	mciSendString(_T("open mus/bgm.mp3 alias bgm"), NULL, 0, NULL);
	
    //初始化
	int score = 0;
	Player player;
	ExMessage msg;
	IMAGE img_menu;
	IMAGE img_background;
	std::vector<Enemy*> enemy_list;
	std::vector<Bullet> bullet_list(3);

	RECT region_btn_start_game, region_btn_quit_game;

	region_btn_start_game.left = (WINDOW_WIDTH - BUTTON_WIDTH) / 2;
	region_btn_start_game.right = region_btn_start_game.left + BUTTON_WIDTH;
	region_btn_start_game.top = 430;
	region_btn_start_game.bottom = region_btn_start_game.top + BUTTON_HEIGHT;

	region_btn_quit_game.left = (WINDOW_WIDTH - BUTTON_WIDTH) / 2;
	region_btn_quit_game.right = region_btn_quit_game.left + BUTTON_WIDTH;
	region_btn_quit_game.top = 550;
	region_btn_quit_game.bottom = region_btn_quit_game.top + BUTTON_HEIGHT;
	//资源加载
	StartGameButton btn_start_game = StartGameButton(region_btn_start_game,
		_T("img/ui_start_idle.png"), _T("img/ui_start_hovered.png"), _T("img/ui_start_pushed.png"));
	QuitGameButton btn_quit_game = QuitGameButton(region_btn_quit_game,
		_T("img/ui_quit_idle.png"), _T("img/ui_quit_hovered.png"), _T("img/ui_quit_pushed.png"));

	loadimage(&img_menu, _T("img/menu.png"));
	loadimage(&img_background, _T("img/background.png"));

	BeginBatchDraw();
	DWORD start_time ;
	DWORD end_time  ;
	DWORD delta_time=0 ;//用于控制帧率的时间差
	DWORD anim_delta_time = 0;//记录绘制一帧所需时间
	while (running)
	{
		start_time =end_time = GetTickCount();
		
		while (peekmessage(&msg))
		{
			if (is_game_started)
				player.ProcessEvent(msg);
			else
			{
				btn_start_game.ProcessEvent(msg);
				btn_quit_game.ProcessEvent(msg);
			}
		}

		if (is_game_started)
		{
			// 尝试生成新的敌人
			TryGenerateEnemy(enemy_list, anim_delta_time);

			// 移动玩家
			player.Move();
			
			// 更新子弹位置
			UpdateBullets(bullet_list, player);
			// 更新敌人位置
			for (Enemy* enemy : enemy_list)
				enemy->Move(player,score);
			
			// 检测子弹和敌人的碰撞
			for (Enemy* enemy : enemy_list)
			{
				for (const Bullet& bullet : bullet_list)
				{
					if (enemy->CheckBulletCollision(bullet))
					{
						mciSendString(_T("play hit from 0"), NULL, 0, NULL);
						enemy->Hurt(anim_delta_time);
						
					}
				}
			}
			// 移除生命值归零的敌人
			for (size_t i = 0; i < enemy_list.size(); i++)
			{
				Enemy* enemy = enemy_list[i];
				if (enemy->CheckAlive()==false)
				{
					std::swap(enemy_list[i], enemy_list.back());
					enemy_list.pop_back();
					delete enemy;
					score++;
				}
			}
			// 检测敌人和玩家的碰撞
			for (Enemy* enemy : enemy_list)
			{
				if (enemy->CheckPlayerCollision(player))
				{
					static TCHAR text[128];
					_stprintf_s(text, _T("最终得分：%d !"), score);
					MessageBox(GetHWnd(), text, _T("游戏结束"), MB_OK);
					running = false;
					break;
				}
			}
		}

		cleardevice();

		if (is_game_started)
		{
			putimage(0, 0, &img_background);
			player.Draw(1000 / 144);
			for (Enemy* enemy : enemy_list)
				enemy->Draw(1000 / 144);
			for (const Bullet& bullet : bullet_list)
				bullet.Draw();
			DrawPlayerScore(score);
		}
		else
		{
			putimage(0, 0, &img_menu);
			btn_start_game.Draw();
			btn_quit_game.Draw();
		}
		//图片渲染
		FlushBatchDraw();
		//计时器属性更新
		end_time = GetTickCount();
		delta_time = end_time - start_time;
		//帧率控制
        if (delta_time < 1000 / 144)
		{
			Sleep(1000 / 144 - delta_time);
		}
		anim_delta_time = GetTickCount() - start_time;
	}

	delete atlas_player_left;
	delete atlas_player_right;
	delete atlas_enemy_left;
	delete atlas_enemy_right;

	EndBatchDraw();

	return 0;
}
```



## 按照通用设计思想参考代码

````c++
int main()
{
	// 初始化

	initgraph(WINDOW_WIDTH, WINDOW_HEIGHT);
	BeginBatchDraw();
	srand((unsigned int)time(nullptr));
	// 获得窗口句柄
	HWND hWnd = GetHWnd();
	// 使用 Windows API 修改窗口名称
	SetWindowText(hWnd, L"提瓦特幸存者");

	// 加载资源: Atlas共享资源,最上层管理
	// 玩家
	std::vector<CharactersAtlas> players_atlas;
	players_atlas.push_back(CharactersAtlas(L"resource/img/paimon_right_%d.png", 6));
	players_atlas.push_back(CharactersAtlas(L"resource/img/theresa_right_%d.png", 11));
	CharactersAtlas& player_atlas_paimon = players_atlas[0];
	CharactersAtlas& player_atlas_theresa = players_atlas[1];
	player_atlas_paimon.loadHeadImg(L"resource/img/avatar_paimon.png");
	player_atlas_theresa.loadHeadImg(L"resource/img/avatar_theresa.png");
	player_atlas_paimon.loadShadowImg(L"resource/img/shadow_player.png");
	player_atlas_theresa.atlas_character_shadow = player_atlas_paimon.atlas_character_shadow;


	// 敌人
	std::vector<CharactersAtlas> enemys_atlas;
	enemys_atlas.push_back(CharactersAtlas(L"resource/img/bee_right_%d.png", 4));
	enemys_atlas.push_back(CharactersAtlas(L"resource/img/boar_right_%d.png", 6));
	enemys_atlas.push_back(CharactersAtlas(L"resource/img/snail_right_%d.png", 8));
	enemys_atlas.push_back(CharactersAtlas(L"resource/img/worm_right_%d.png", 6));
	CharactersAtlas& enemy_atlas_bee = enemys_atlas[0];
	CharactersAtlas& enemy_atlas_boar = enemys_atlas[1];
	CharactersAtlas& enemy_atlas_snail = enemys_atlas[2];
	CharactersAtlas& enemy_atlas_worm = enemys_atlas[3];
	enemy_atlas_bee.loadShadowImg(L"resource/img/shadow_enemy.png");
	enemy_atlas_worm.atlas_character_shadow = enemy_atlas_snail.atlas_character_shadow
		= enemy_atlas_boar.atlas_character_shadow = enemy_atlas_bee.atlas_character_shadow;

	std::shared_ptr<StartGameButton> btn_start_game = nullptr;
	std::shared_ptr<QuitGameButton> btn_quit_game = nullptr;
	loadButtonImage(btn_start_game, btn_quit_game);

	ChoicePlayerButton btn_choice_player_paimon(RECT(), L"resource/img/avatar_paimon.png", L"resource/img/avatar_paimon.png", L"resource/img/avatar_paimon.png");
	ChoicePlayerButton btn_choice_player_theresa(RECT(), L"resource/img/avatar_theresa.png", L"resource/img/avatar_theresa.png", L"resource/img/avatar_theresa.png");
	btn_choice_player_paimon.setRegion(PAIMON, true);
	btn_choice_player_theresa.setRegion(THERESA, false);

	ExMessage msg;
	IMAGE img_backgraund;
	IMAGE img_menu;

	CharactersAtlas* cur_player = &player_atlas_paimon;
	Player player_paimon(cur_player->get_left(), cur_player->get_right(), cur_player->get_left_sketch(), cur_player->get_right_sketch(), cur_player->get_shadow(), cur_player->get_head());
	player_paimon.setCharaterAttribute(CharaterAttribute(40, 5, 1, 1000, 3));
	cur_player = &player_atlas_theresa;
	Player player_theresa(cur_player->get_left(), cur_player->get_right(), cur_player->get_left_sketch(), cur_player->get_right_sketch(), cur_player->get_shadow(), cur_player->get_head());
	player_theresa.setCharaterAttribute(CharaterAttribute(30, 5, 3, 1000, 6));
	Player* player = &player_paimon;

	std::vector<Enemy*> enemy_list;
	std::vector<Bullet> bullet_list;	// todo:增加非绕玩家旋转子弹
	int score = 0;

	loadimage(&img_backgraund, L"resource/img/background.png");
	loadimage(&img_menu, L"resource/img/menu.png");
	DWORD anim_delta_time = 0;

	while (running)
	{
		// 返回从操作系统启动所经过的毫秒数
		DWORD begin_time = ::GetTickCount();

		// 处理消息: 异步
		if (peekmessage(&msg, EX_KEY | EX_MOUSE))
		{
			if (is_started_game)
				player->processEvent(msg);
			else if (is_choice_player)
			{
				btn_choice_player_paimon.processEvent(msg);
				btn_choice_player_theresa.processEvent(msg);

				if (player_choice == PAIMON)
					player = &player_paimon;
				else if (player_choice == THERESA)
					player = &player_theresa;
			}
			else
			{
				btn_start_game->processEvent(msg);
				btn_quit_game->processEvent(msg);
			}
		}

		// 处理数据
		if (is_started_game)
		{
			CharactersAtlas* enemy = nullptr;
			CharaterAttribute enemy_attri;
			int choice_enemy = rand() % 10;
			// 蜜蜂敌人
			if (choice_enemy <= 1) {
				enemy_attri = CharaterAttribute(30, 1, 0, 300);
				enemy = &enemy_atlas_bee;
			}
			// 源石虫敌人
			else if (choice_enemy <= 5) {
				enemy_attri = CharaterAttribute(18, 2, 0, 400);
				enemy = &enemy_atlas_worm;
			}
			// 野猪敌人
			else if (choice_enemy <= 8) {
				enemy_attri = CharaterAttribute(22, 2, 0, 500);
				enemy = &enemy_atlas_boar;
			}
			// 蜗牛敌人
			else if (choice_enemy == 9) {
				enemy_attri = CharaterAttribute(15, 3, 0, 600);
				enemy = &enemy_atlas_snail;
			}
			tryGenerateEnmey(enemy_list, enemy->get_left(), enemy->get_right(), enemy->get_left_sketch(), enemy->get_right_sketch(), enemy->get_shadow(), enemy_attri);

			player->move();
			player->updateStatus(anim_delta_time);
			for (Enemy* enemy : enemy_list)
			{
				enemy->updateStatus(anim_delta_time);
				enemy->move(*player);
			}
			updateBullets(bullet_list, *player);

			// 玩家与敌人碰撞检测
			for (Enemy* enemy : enemy_list)
			{
				if (enemy->checkPlayerCollision(*player)) {
					player->hurt();
					// 回到开始界面,重置敌人,玩家;
					if (player->checkAlive() == false) {
						std::wstring s;
						if (score < 120) s += L"唉,结束了";
						else if (score < 240) s += L"哟,有点长进";
						else if (score < 360) s += L"呵,又结束了";
						else if (score < 1000) s += L"嗯,还行";
						else s += L"厉害,厉害.";
						s += L"\n共计得分: ";
						s += std::to_wstring(score);
						MessageBox(GetHWnd(), s.c_str(), L"游戏结束", MB_OK);

						score = 0;
						is_started_game = false;
						is_choice_player = false;
						for (Enemy* enemy : enemy_list)
							enemy->kill();
						player->reset();
						break;
					}
				}
			}
			// 子弹与敌人碰撞检测
			for (Bullet& bullet : bullet_list)
			{
				for (Enemy* enemy : enemy_list)
				{
					if (enemy->checkAlive() && enemy->checkBulletCollision(bullet)) {
						int damage_value = enemy->hurt();
						score += damage_value;
						player->incrementMP(damage_value);
					}
				}
			}

			// 删除生命值为零的敌人
			for (int i = 0; i < enemy_list.size(); )
			{
				if (!enemy_list[i]->checkAlive()) {
					Enemy* enemy = enemy_list[i];
					std::swap(enemy_list[i], enemy_list.back());
					enemy_list.pop_back();
					delete enemy;
					if(is_started_game) {
						score++;
						player->incrementMP(1);
					}
					continue;
				}
				++i;
			}
		}


		// 渲染图片
		cleardevice();

		if (is_started_game)
		{
			putimage(0, 0, &img_backgraund);
			player->draw(anim_delta_time);
			for (Enemy* enemy : enemy_list)
				enemy->draw(anim_delta_time);
			for (Bullet& bullet : bullet_list)
				bullet.draw();
			player->drawStatusLine(score);
		}
		else if (is_choice_player)
		{
			putimage(0, 0, &img_backgraund);
			btn_choice_player_paimon.draw();
			btn_choice_player_theresa.draw();
		}
		else
		{
			putimage(0, 0, &img_menu);
			btn_start_game->draw();
			btn_quit_game->draw();
			setbkmode(TRANSPARENT);
			settextcolor(RGB(255, 128, 0));
			outtextxy(520, 690, L"Tip: 角色移动[W] [A] [S] [D] or 方向键");
		}

		FlushBatchDraw();

		// 帧率控制
		DWORD end_time = ::GetTickCount();
		DWORD delta_time = end_time - begin_time;
		if (delta_time < 1000 / 144)
			Sleep(1000 / 144 - delta_time);
		anim_delta_time = GetTickCount() - begin_time;
	}

	EndBatchDraw();
	closegraph();
	if (thread_music) {
		thread_music->join();
		delete thread_music;
	}

	return 0;
}
````

代码参考：rebotzz、Voidmatrix

项目教程：【【从零开始的C++游戏开发】全宇宙最简单的类吸血鬼幸存者游戏开发 | EasyX制作提瓦特幸存者】https://www.bilibili.com/video/BV1eM4m1S74K?vd_source=3a9720f4e51b97861a15c946ae6f0c2d

文档错误请联系QQ1210965642
